---
title: "Br26"
author: "Johannes Gawron"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Splitting statistics

This code analyses splitting statistics for CTC-clusters.

The analysis takes a list of trees sampled from its posterior distribution as input and samples mutations placements for each of the trees.


## Configure the script
```{r config}
inputFolder <- "../../../input_folder"
simulationInputFolder <- "../../../simulations/simulations2"
treeName <- "Br26"
nTreeSamplingEvents <- 100
nMutationSamplingEvents <- 100
```

## Loading data
```{r load}
source("../functions.R")


input <- load_data(inputFolder, treeName)

postSampling <- input$postSampling
nClusters <- input$nClusters
ClusterID <- input$clusterID
nCells <- input$nCells  
nMutations <- input$nMutations
nClusters <- input$nClusters
alleleCount <- input$alleleCount
mutatedReadCounts <- input$mutatedReadCounts
totalReadCounts <- input$totalReadCounts
sampleDescription <- input$sample_description
```


## Sample description 

Each row corresponds to a cell.
Column description:
  - Cluster: An number indicating which sample the cell belongs to.
  - ClusterName: The name of the sample in the nodeDescription.tsv file
  - WBC: a binary vector indicating whether the cell is a white blood cell (1) or not (0).
  - color: Indicates the color of the cluster in the tree, as described in the nodeDescription.tsv
          file.
  
```{r Describe samples}
print(sampleDescription)
```



Get null distributions of relevant statistics, stratified by sample:
```{r}
cutoffsSplittingProbs <- data.frame(clusterSize = vector(), Cutoff = vector())
cutoffsBranchingProbabilities <- data.frame(clusterSize = vector(), Cutoff = vector())

for (clusterSize in 2:5){
  try(
  {treeNameSimulated <- paste(treeName, clusterSize, sep = '_')


  inputSimulated <- load_data(simulationInputFolder, treeNameSimulated)

  postSamplingSimulated <- inputSimulated$postSampling
  nClustersSimulated <- inputSimulated$nClusters
  ClusterIDSimulated <- inputSimulated$clusterID
  nCellsSimulated <- inputSimulated$nCells  
  nMutationsSimulated <- inputSimulated$nMutations
  nClustersSimulated <- inputSimulated$nClusters
  alleleCountSimulated <- inputSimulated$alleleCount
  mutatedReadCountsSimulated <- inputSimulated$mutatedReadCounts
  totalReadCountsSimulated <- inputSimulated$totalReadCounts
  sampleDescriptionSimulated <- inputSimulated$sample_description
  
  distance <- computeClusterSplits(sampleDescriptionSimulated, postSamplingSimulated, treeNameSimulated, nCellsSimulated,
                     nMutationsSimulated, nClustersSimulated,
                     alleleCountSimulated,
                     mutatedReadCountsSimulated, totalReadCountsSimulated,
                     nMutationSamplingEvents = nMutationSamplingEvents, nTreeSamplingEvents = nTreeSamplingEvents,
                     cellPairSelection = c("orchid", "orchid1", "orchid2",
                                           "orchid3", "orchid4", "darkorchid",
                                           "darkorchid1","darkorchid2", "darkorchid3",
                                           "darkorchid4", "purple", "purple1",
                                           "purple2", "purple3", "purple4"))

  

  plot(ggplot(distance$splittingProbs, aes(x = "Values", y = Splitting_probability, fill = 'Splitting_probability')) +
    geom_boxplot())
  cutoffsSplittingProbs <- rbind(cutoffsSplittingProbs, data.frame(clusterSize = clusterSize, Cutoff = mean(distance$splittingProbs$Splitting_probability) + 2 * sd(distance$splittingProbs$Splitting_probability) ))
  
  ##Note that the way the aggregatedBranchingProbabilities are computed all pairs of cells from the same cluster are
  ## taken into account. This has the effect that clusters with more cells would be counted more often and contribute more
  ## to the shape of the final distribution. This is no problem right now as we only aggregate counts from clusters
  ## of the same size, it is however the potential source of a future bug!!
  
  plot(ggplot(data.frame(x = distance$aggregatedBranchingProbabilities), aes(x = x)) +
    geom_histogram(binwidth = 0.01))
  print(data.frame(clusterSize = clusterSize, Cutoff = quantile(distance$aggregatedBranchingProbabilities, probs = 0.95, names = FALSE)[1] ))
  cutoffsBranchingProbabilities <- rbind(cutoffsBranchingProbabilities, data.frame(clusterSize = clusterSize, Cutoff = quantile(distance$aggregatedBranchingProbabilities, probs = 0.95, names = FALSE)[1] ))
  })
}
```



Get the relevant statistics for each of the clusters of a dataset and output numbers of oligoclonal clusters:
```{r}
nTumorClusters <- 0
nOligoclonalClusters1 <- 0
nOligoclonalClusters2 <- 0
splittingSummary1 <- data.frame(Color = vector(), Oligoclonal = vector(), ClusterSize = vector())
splittingSummary2 <- data.frame(Color = vector(), Oligoclonal = vector(), ClusterSize = vector())

for(clusterSize in 2:5){
  try({
    clusterColor <- sampleDescription %>%
    filter(WBC ==0 &  color != 'gray93') %>%
    group_by(color) %>%
    filter(n() == clusterSize) %>%
    pull(color) %>%
    unique() 
    
    for(color in clusterColor){
      distance <- computeClusterSplits(sampleDescription, postSampling, treeName, nCells,
                     nMutations, nClusters,
                     alleleCount,
                     mutatedReadCounts, totalReadCounts,
                     nMutationSamplingEvents = nMutationSamplingEvents, nTreeSamplingEvents = nTreeSamplingEvents,
                     cellPairSelection = c(color))

      splittingProbs <- mean(distance$splittingProbs$Splitting_probability)
      branchingProbs <- mean(distance$aggregatedBranchingProbabilities)
    
      nTumorClusters <- nTumorClusters + 1
      oligoclonal <- FALSE
      print(clusterSize)
      print(cutoffsSplittingProbs[(cutoffsSplittingProbs$clusterSize == clusterSize), 2])
      if(splittingProbs > (cutoffsSplittingProbs[(cutoffsSplittingProbs$clusterSize == clusterSize), 2])){
        nOligoclonalClusters1 <- nOligoclonalClusters1 + 1
        oligoclonal <- TRUE
      }
      splittingSummary1 <- rbind(splittingSummary1, data.frame(Color = color, Oligoclonal = oligoclonal, ClusterSize = clusterSize))
      oligoclonal <- FALSE
      if(branchingProbs > cutoffsBranchingProbabilities[(cutoffsBranchingProbabilities$clusterSize == clusterSize), 2]){
        nOligoclonalClusters2 <- nOligoclonalClusters2 + 1
        oligoclonal <- TRUE
      }
      splittingSummary2 <- rbind(splittingSummary2, data.frame(Color = color, Oligoclonal = oligoclonal, ClusterSize = clusterSize))
    }
  })
}


numberOfCancerClusters <- sampleDescription %>%
    filter(WBC ==0 &  color != 'gray93') %>%
    group_by(color) %>%
    filter(n() > 1) %>%
    pull(color) %>%
    unique() %>% length() 

print(sprintf('%d out of %d clusters were found to be oligoclonal in %s, using method 1', nOligoclonalClusters1, numberOfCancerClusters, treeName))
print(sprintf('%d out of %d clusters were found to be oligoclonal in %s, using method 2', nOligoclonalClusters2, numberOfCancerClusters, treeName))
print(splittingSummary1)
print(splittingSummary2)
```



